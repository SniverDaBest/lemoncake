#!/bin/bash

set -e

cat << 'EOF'
 _                                         _
| |    ___ _ __ ___   ___  _ __   ___ __ _| | _____
| |   / _ | '_ ` _ \ / _ \| '_ \ / __/ _` | |/ / _ \
| |__|  __| | | | | | (_) | | | | (_| (_| |   |  __/
|_____\___|_| |_| |_|\___/|_| |_|\___\__,_|_|\_\___|


EOF

if [ "$#" -lt 1 ]; then
    echo "Usage: $0 {run|build|clean|help}"
    exit 1
fi

if [ "$#" -gt 1 ]; then
    if [ "$2" = "--release" ]; then
        release=true
        echo "Building for release mode..."
    else
        release=false
    fi
else
    release=false
fi

function build() {
    mkdir -p bin/esp/efi/boot

    if [ release ]; then
        cargo build --release
        cp target/x86_64-unknown-uefi/release/lemoncake.efi bin/esp/efi/boot/bootx64.efi
    else
        cargo build
        cp target/x86_64-unknown-uefi/debug/lemoncake.efi bin/esp/efi/boot/bootx64.efi
    fi

    #if [ linker.ld -nt bin/kernel.bin ] || [ bin/boot.o -nt bin/kernel.bin ] || [ bin/liblemoncake.a -nt bin/kernel.bin ] || [ bin/kernel.bin -nt lemoncake.iso ] || [ grub.cfg -nt lemoncake.iso ]; then
    #    ld -n -o bin/kernel.bin -T linker.ld bin/boot.o bin/liblemoncake.a
    #    mkdir -p bin/iso/boot/grub
    #
    #    cp grub.cfg bin/iso/boot/grub/
    #    cp bin/kernel.bin bin/iso/boot/
    #
    #    grub2-mkrescue -o lemoncake.iso bin/iso
    #fi
}

function run() {
    build
    #if [ ! -f hd.img ]; then
    #    echo "Creating hard drive image..."
    #    qemu-img create hd.img 128M
    #fi
    cp ovmf_vars.bin bin/
    cp ovmf_code.bin bin/
    qemu-system-x86_64 -enable-kvm \
    -bios bin/ovmf.bin\
    -drive format=raw,file=fat:rw:bin/esp\
    -m 256M
}

function clean() {
    rm -rf bin/ target/ *.iso
}

case "$1" in
    run)
        run
        ;;

    build)
        build
        ;;
    
    clean)
        clean
        ;;
        
    help)
        echo "Usage: $0 {run|build|clean|help}"
        echo "  run   - Run Lemoncake"
        echo "  build - Build Lemoncake"
        echo "  clean - Clean the workspace"
        echo "  help  - Display this message"
        ;;
        
    *)
        echo "Error: Invalid argument '$1'"
        echo "Usage: $0 {run|build|help}"
        exit 1
        ;;
        
esac
